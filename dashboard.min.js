let guideContent={},tripConfig={};const DOM={dayTabsContainer:document.getElementById('day-tabs'),contentDisplay:document.getElementById('content-display'),modal:document.getElementById('guide-modal'),modalBody:document.getElementById('modal-body'),closeModalBtn:document.querySelector('.modal-close')};async function loadConfig(){try{const response=await fetch('config.json',{cache:'no-cache'});if(!response.ok){throw new Error(`無法讀取 config.json: ${response.status}`);}return await response.json();}catch(error){console.error('讀取設定檔失敗:',error);throw error;}}function updateStaticText(){document.title=`${tripConfig.tripTitle} ${tripConfig.tripYear} - ${tripConfig.pageTitle}`;document.getElementById('main-title').textContent=`${tripConfig.tripTitle} ${tripConfig.tripYear}`;document.getElementById('main-subtitle').textContent=tripConfig.mainSubtitle;document.getElementById('welcome-message').textContent=tripConfig.welcomeMessage;document.getElementById('footer-text').textContent=tripConfig.footerText;document.querySelector('.background-container').style.backgroundImage=`url('${tripConfig.backgroundImageUrl}')`;}async function initializeApp(){try{tripConfig=await loadConfig();updateStaticText();const{itineraryData,accommodationMap,guideData}=await loadAllData();guideContent=guideData;if(itineraryData.length===0){throw new Error('解析行程資料後為空陣列。');}renderDayTabs(itineraryData,accommodationMap);selectInitialDay(itineraryData);}catch(error){console.error('初始化失敗:',error);displayErrorMessage(error);}}async function loadAllData(){try{const fetchOptions={cache:'no-cache'};const[itineraryResponse,accommodationResponse,guideResponse]=await Promise.all([fetch(tripConfig.itineraryFileName,fetchOptions).catch(e=>({ok:false,status:e.toString()})),fetch(tripConfig.accommodationFileName,fetchOptions).catch(e=>({ok:false,status:e.toString()})),fetch(tripConfig.guideFileName,fetchOptions).catch(e=>({ok:false,status:e.toString()}))]);if(!itineraryResponse.ok||!accommodationResponse.ok||!guideResponse.ok){throw new Error(`讀取資料檔案失敗: 
                行程: ${itineraryResponse.status}, 
                住宿: ${accommodationResponse.status}, 
                指南: ${guideResponse.status}`);}return{itineraryData:parseItinerary(await itineraryResponse.text()),accommodationMap:parseAccommodation(await accommodationResponse.text(),tripConfig.tripYear),guideData:await guideResponse.json()};}catch(error){console.error('資料讀取失敗:',error);throw error;}}function parseCsvLine(line){const parts=[];let currentField='';let inQuotes=false;for(let i=0;i<line.length;i++){const char=line[i];if(char==='"'&&(i===0||line[i-1]!=='"')){inQuotes=!inQuotes;}else if(char===','&&!inQuotes){parts.push(currentField);currentField='';}else{currentField+=char;}}parts.push(currentField);return parts.map(field=>field.trim().replace(/^"|"$/g,'').replace(/""/g,'"'));}function parseItinerary(csvString){const lines=csvString.trim().split(/\r?\n/);const tripData=[];let currentDayData=null;const dayHeaderRegex=/^第(.+?)天：(.+?)\s*[-－–—]\s*(.+?)(,)*$/;lines.forEach(line=>{const dayMatch=line.match(dayHeaderRegex);if(dayMatch){if(currentDayData)tripData.push(currentDayData);currentDayData={day:dayMatch[1].trim(),date:dayMatch[2].trim().replace('（',' (').replace('）',')'),title:dayMatch[3].trim(),events:[]};}else if(currentDayData&&line.trim()&&!line.startsWith('時間,行程')){const parts=parseCsvLine(line);if(parts.length>=2&&parts[1]?.trim()){currentDayData.events.push({time:parts[0]||'N/A',activity:parts[1]||'N/A',notes:parts[4]||'',guideKey:parts[5]||'',googleMapLink:parts[6]||''});}}});if(currentDayData)tripData.push(currentDayData);return tripData;}function parseAccommodation(csvString,year){const lines=csvString.trim().split(/\r?\n/);const accommodationMap={};const numericYear=parseInt(year,10);for(let i=1;i<lines.length;i++){const line=lines[i];if(!line.trim())continue;const parts=parseCsvLine(line);if(parts.length<10)continue;const[dateRange,region,platform,roomType,breakfast,kitchen,parking,link,address,mapLink]=parts;if(!dateRange?.trim())continue;const accommodation={region,platform,name:link,roomType,parking,kitchen,breakfast,address,mapLink};const[startDateStr,endDateStr]=dateRange.split('-');if(!startDateStr)continue;const[startMonth,startDay]=startDateStr.split('/').map(Number);const[endMonth,endDay]=endDateStr?endDateStr.split('/').map(Number):[startMonth,startDay];let currentDate=new Date(numericYear,startMonth-1,startDay);const endDate=new Date(numericYear,endMonth-1,endDay);while(currentDate<=endDate){const key=`${currentDate.getMonth()+1}/${currentDate.getDate()}`;accommodationMap[key]=accommodation;currentDate.setDate(currentDate.getDate()+1);}}return accommodationMap;}function createEventTimelineItem(event){const guideKey=Object.keys(guideContent).find(key=>event.guideKey?.includes(key));const guideButton=guideKey?`<button class="guide-btn inline-block ml-3 text-yellow-400 hover:text-yellow-300" data-guide-key="${guideKey}"><i data-lucide="book-open" class="w-5 h-5"></i></button>`:'';const mapLink=event.googleMapLink?`<a href="${event.googleMapLink}" target="_blank" rel="noopener noreferrer" class="inline-block ml-3 text-blue-400 hover:text-blue-300"><i data-lucide="map-pin" class="w-5 h-5"></i></a>`:'';const notes=event.notes?`<p class="text-gray-400 mt-1 text-sm">${event.notes}</p>`:'';return`
                <div class="timeline-item relative pl-8 pb-8">
                    <div class="timeline-dot"></div>
                    <p class="text-blue-300 font-semibold">${event.time}</p>
                    <h4 class="text-lg font-semibold text-gray-100 mt-1 flex items-center">
                        ${event.activity}
                        ${guideButton}
                        ${mapLink}
                    </h4>
                    ${notes}
                </div>
            `;}function createItinerarySection(dayData){const eventsList=dayData.events.map(createEventTimelineItem).join('');return`
                <div class="mb-8 lg:mb-0">
                    <h3 class="text-xl sm:text-2xl font-bold text-white mb-4 flex items-center">
                        <i data-lucide="list-checks" class="w-6 h-6 mr-3 text-blue-400"></i>
                        行程安排
                    </h3>
                    <div class="relative pl-8">
                        ${eventsList}
                    </div>
                </div>
            `;}function createAmenityIcon(value,checkIcon=!0){if(!value)return'';const hasAmenity=value.toLowerCase().includes('v');if(hasAmenity)return'<i data-lucide="check-circle-2" class="w-4 h-4 text-green-400"></i>';if(value.toLowerCase().includes('x'))return'<i data-lucide="x-circle" class="w-4 h-4"></i>';return value;}function createAccommodationSection(accommodationData){if(!accommodationData){return`
                    <div>
                        <h3 class="text-xl sm:text-2xl font-bold text-white mb-4 flex items-center">
                            <i data-lucide="moon-star" class="w-6 h-6 mr-3 text-purple-400"></i>
                            今晚住宿
                        </h3>
                        <div class="bg-gray-800 p-6 rounded-lg border border-gray-700 text-center">
                            <p class="text-gray-400">今天為返程日或無預定住宿。</p>
                        </div>
                    </div>
                `;}const platformColor=accommodationData.platform==='AirBnb'?'bg-pink-600':'bg-blue-600';const parking=createAmenityIcon(accommodationData.parking);const kitchen=createAmenityIcon(accommodationData.kitchen);const breakfast=createAmenityIcon(accommodationData.breakfast);return`
                <div>
            <h3 class="text-xl sm:text-2xl font-bold text-white mb-4 flex items-center">
                <i data-lucide="home" class="w-6 h-6 mr-3 text-green-400"></i>
                今晚住宿
            </h3>
            <div class="bg-gray-800 p-4 sm:p-6 rounded-lg border border-gray-700">
                <div class="flex justify-between items-start">
                    <h4 class="text-lg sm:text-xl font-bold text-white">${accommodationData.region}</h4>
                    <span class="text-sm font-medium ${platformColor} text-white px-2 py-1 rounded-full">${accommodationData.platform}</span>
                </div>
                <p class="text-gray-300 mt-1 mb-4 font-semibold text-sm sm:text-base">${accommodationData.name}</p>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm mt-4">
                    <div class="flex items-start">
                        <i data-lucide="bed-double" class="w-4 h-4 mr-2 mt-1 text-gray-400 flex-shrink-0"></i>
                        <div><span class="font-semibold text-gray-300">房型:</span> ${accommodationData.roomType || 'N/A'}</div>
                    </div>
                    <div class="flex items-center">
                        <i data-lucide="parking-circle" class="w-4 h-4 mr-2 text-gray-400"></i>
                        <span class="font-semibold text-gray-300 mr-2">停車:</span>
                        ${parking}
                    </div>
                    <div class="flex items-center">
                        <i data-lucide="soup" class="w-4 h-4 mr-2 text-gray-400"></i>
                        <span class="font-semibold text-gray-300 mr-2">廚房:</span>
                        ${kitchen}
                    </div>
                    <div class="flex items-center">
                        <i data-lucide="croissant" class="w-4 h-4 mr-2 text-gray-400"></i>
                        <span class="font-semibold text-gray-300 mr-2">早餐:</span>
                        ${breakfast}
                    </div>
                </div>

                <a href="${accommodationData.mapLink}" target="_blank" rel="noopener noreferrer" class="mt-6 flex items-center text-blue-400 hover:text-blue-300 transition-colors duration-200 text-sm">
                    <i data-lucide="map-pin" class="w-4 h-4 mr-2"></i>
                    <span class="underline">${accommodationData.address}</span>
                </a>
            </div>
        </div>
    `;}function renderDayDetails(dayData,accommodationData){const itineraryHtml=createItinerarySection(dayData);const accommodationHtml=createAccommodationSection(accommodationData);DOM.contentDisplay.innerHTML=`
                <h2 class="text-2xl sm:text-3xl font-bold text-white mb-1">第 ${dayData.day} 天: ${dayData.title}</h2>
                <p class="text-base sm:text-lg text-gray-400 mb-6 sm:mb-8">${dayData.date}</p>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    ${itineraryHtml}
                    ${accommodationHtml}
                </div>
            `;lucide.createIcons();addGuideButtonListeners();}function openGuideModal(key){const data=guideContent[key];if(data){DOM.modalBody.innerHTML=`<h3>${data.title}</h3>${data.content}`;DOM.modal.style.display='block';}}function closeGuideModal(){DOM.modal.style.display='none';}function addGuideButtonListeners(){document.querySelectorAll('.guide-btn').forEach(btn=>{btn.addEventListener('click',()=>{openGuideModal(btn.dataset.guideKey);});});}function getAccommodationForDay(dayDate,accommodationMap){const dateParts=dayDate.match(/(\d+)\s*月\s*(\d+)/);if(!dateParts)return null;const key=`${parseInt(dateParts[1])}/${parseInt(dateParts[2])}`;return accommodationMap[key]||null;}function createDayTab(day,accommodationMap){const tab=document.createElement('button');tab.className='day-tab px-4 py-2 rounded-lg text-sm font-semibold bg-gray-800 text-gray-300 border border-gray-700';tab.innerHTML=`第 ${day.day} 天 <span class="hidden sm:inline-block ml-2 text-gray-400">${day.date.split(' ')[0]}</span>`;tab.onclick=()=>{document.querySelectorAll('.day-tab').forEach(t=>t.classList.remove('active'));tab.classList.add('active');const accommodationData=getAccommodationForDay(day.date,accommodationMap);renderDayDetails(day,accommodationData);};return tab;}function renderDayTabs(itineraryData,accommodationMap){DOM.dayTabsContainer.innerHTML='';itineraryData.forEach(day=>{const tab=createDayTab(day,accommodationMap);DOM.dayTabsContainer.appendChild(tab);});}function findTodayIndex(itineraryData){const today=new Date();const currentMonth=today.getUTCMonth()+1;const currentDay=today.getUTCDate();const todayFormatted=`${currentMonth} 月 ${currentDay} 日`;return itineraryData.findIndex(day=>day.date.startsWith(todayFormatted));}function selectInitialDay(itineraryData){const todayIndex=findTodayIndex(itineraryData);const targetTab=todayIndex!==-1?DOM.dayTabsContainer.children[todayIndex]:DOM.dayTabsContainer.firstElementChild;if(targetTab){targetTab.click();}}function displayErrorMessage(error){DOM.contentDisplay.innerHTML=`
        <div class="flex flex-col justify-center items-center h-full min-h-[40vh] text-center">
            <i data-lucide="alert-triangle" class="w-12 h-12 text-red-400 mb-4"></i>
            <h3 class="text-xl font-bold text-red-300">載入行程資料時發生錯誤</h3>
            <p class="text-gray-400 mt-2">請確認 CSV 和 JSON 檔案都存在且格式正確。</p>
            <p class="text-xs text-gray-500 mt-4">${error.message}</p>
        </div>
    `;lucide.createIcons();}document.addEventListener('DOMContentLoaded',initializeApp);DOM.closeModalBtn.addEventListener('click',closeGuideModal);window.addEventListener('click',event=>{if(event.target===DOM.modal){closeGuideModal();}});